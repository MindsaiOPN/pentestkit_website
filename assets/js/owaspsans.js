/*
	Industrious by TEMPLATED
	templated.co @templatedco
	Released for free under the Creative Commons Attribution 3.0 license (templated.co/license)
*/
(function ($) {


	$('#sans25only').on('click', function () {

		$('#showall, #mitre25only').removeClass('primary')
		$('#sans25only').addClass('primary')
		$("[data-cwe='yes']").hide("slow")
		$("[data-sans25='yes']").show("slow", function () {
			$("[data-sans25='yes']").addClass('sans25row')
			
		})
	})

	$('#mitre25only').on('click', function () {

		$('#showall, #sans25only').removeClass('primary')
		$('#mitre25only').addClass('primary')
		$("[data-cwe='yes']").hide("slow")
		$("[data-mitre25='yes']").show("slow", function () {
			$("[data-mitre25='yes']").addClass('mitre25row')
		})
	})

	$('#showall').on('click', function () {
		$("[data-sans25='yes']").removeClass('sans25row')
		$('#sans25only, #mitre25only').removeClass('primary')
		$('#showall').addClass('primary')
		$("[data-cwe='yes']").show("slow").removeClass('sans25row').removeClass('mitre25row')
	})

	function bindTable(id, params) {
		params.paging = false
		params.ordering = false
		params.info = false
		params.searching = false
		params.sorting = false
		params.dom = 'frtip'
		//params.buttons = [ 'copyHtml5', 'excelHtml5', 'pdfHtml5', 'csvHtml5' ]


		let table
		if ($.fn.dataTable.isDataTable(id)) {
			table = $(id).DataTable()
			table.clear().rows.add(params.data).draw()
		} else {
			table = $(id).DataTable(params)
			// if (params.buttons) {
			//     table.buttons().container()
			//         .appendTo($('.col-sm-6:eq(0)', table.table().container()));
			// }
		}
		return table
	}

	let dt = new Array()
	fetch('./assets/js/owasp.json')
		.then(response => response.json())
		.then(data => {
			let sans25 = data.SANS25
			let mitre25 = data.MITRE25
			Object.keys(data.OWASPTop10).forEach((key) => {
				let item = data.OWASPTop10[key], record = item.name, sans = '<table style="font-size:small">'
				Object.keys(item.cwe).forEach((k) => {
					let cwe = item.cwe[k]
					let isSans25 = sans25.filter(e => e.name == cwe.name)
					let isMitre25 = mitre25.filter(e => e.name == cwe.name)
					sans += `<tr data-cwe="yes" data-sans25="${isSans25?.length ? "yes" : "no"}" data-mitre25="${isMitre25?.length ? "yes" : "no"}"><td>${cwe.name}</td><td>${cwe.description}</td></tr>`
				})
				sans += '</table>'
				dt.push([record, sans])
			})

			let params = { "data": dt, "columns": [{ width: "30%" }, { width: "70%" }] }
			let table = bindTable('#tbl_owasp', params)



			$("[data-cwe='yes']").each(function () {
				var backgrounds = [];
				if ($(this).attr("data-sans25") == 'yes')
					backgrounds.push("url('/images/sans.svg')")

				if ($(this).attr("data-mitre25") == 'yes')
					backgrounds.push("url('/images/cwe_logo.jpeg')")

				$(this).css("background-image", backgrounds.join(", "))
				$(this).css("background-repeat", 'no-repeat, no-repeat')
				$(this).css("background-size", '20px, 20px')
				$(this).css("background-position-x", 'right, right')
				$(this).css("background-position-y", '0px, 12px')
			})

		})


	// table.columns.adjust().draw()
	// $('.loader.owasp').hide()


})(jQuery);