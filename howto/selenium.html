<script>


    let extensionId = null

    document.addEventListener("ptk_extension_event", function (data) {
        // success: true / false,
        // result: result,
        // error: error

        //init_recording
        //start_recording
        //stop_recording
        //export_recording
        //reset_recording

        if (data.detail?.success) {
            document.getElementById('export').value = data.detail.event + '\r\n-------------\r\n' + data.detail.result
        } else {
            document.getElementById('export').value = data.detail.event + '\r\n-------------\r\n' + data.detail.error
        }

    })

    function initExtension() {
        window.postMessage({
            channel: 'ptk_messages_channel',
            command: 'init_recording'
        }, '*')
    }



    function startRecording(url) {
        window.postMessage({
            channel: 'ptk_messages_channel',
            command: 'start_recording',
            params: {
                start_url: document.getElementById('startUrl').value,
                clean_cookie: false
            }
        }, '*')
    }

    function stopRecording() {
        window.postMessage({
            channel: 'ptk_messages_channel',
            command: 'stop_recording'
        }, '*')
    }


    function resetRecording() {
        window.postMessage({
            channel: 'ptk_messages_channel',
            command: 'reset_recording'
        }, '*')
    }


    function exportRecording() {
        document.getElementById('export').value = "";
        window.postMessage({
            channel: 'ptk_messages_channel',
            command: 'export_recording',
            params: {
                element: 'export', // element id
                settings: {
                    format: "xml", // [xml, har]
                    min_duration: 3000,
                    element_path: "id", //[id, fullpath]
                    event_type: "javascript", //[javascript, driverclick, onclick ]
                }
            }
        }, '*')
    }


    function checkMacro() {
        var parser = new DOMParser();
        var text = document.getElementById('export').value;
        var xmlDoc = parser.parseFromString(text, "text/xml");

        if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
            //checkErrorXML(xmlDoc.getElementsByTagName("parsererror")[0]);
            alert(xt)
        }
        else {
            alert("No errors found");
        }
    }
</script>
<!-- Main -->

<div class="inner">
    <div class="content">
        <h3>Selenium tests integration</h3>
        <p>PTK use window.postMessage mechanism - see on this <a
                href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage">link</a> 
            <br/>
            To start the PTK scan from Selenium tests use javascript executor
            </p>
    <pre><code>
    driver.Navigate().GoToUrl("http://demo.testfire.net/index.jsp");
    Thread.Sleep(2000);

    IJavaScriptExecutor js = (IJavaScriptExecutor)driver;
    js.ExecuteScript("window.postMessage({'ptk_rattacker':'start'})");
    Thread.Sleep(1000);

    // tests execution
    
    Thread.Sleep(1000);
    js.ExecuteScript("window.postMessage({'ptk_rattacker':'stop'});");
    Thread.Sleep(5000);
    string result = (string) js.ExecuteScript("return window.ptk_scan_result;");
    </code></pre>
        <hr />
        <h4>Supported commands:</h4>
        <ul>
            <li>{'ptk_rattacker':'start'}</li>
            <li>{'ptk_rattacker':'stop'}</li>
        </ul>
     
        <hr />

    </div>
</div>