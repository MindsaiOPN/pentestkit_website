<script>


    let extensionId = null

    document.addEventListener("ptk_extension_event", function (data) {
        // success: true / false,
        // result: result,
        // error: error

        //init_recording
        //start_recording
        //stop_recording
        //export_recording
        //reset_recording

        if (data.detail?.success) {
            document.getElementById('export').value = data.detail.event + '\r\n-------------\r\n' + data.detail.result
        } else {
            document.getElementById('export').value = data.detail.event + '\r\n-------------\r\n' + data.detail.error
        }

    })

    function initExtension() {
        window.postMessage({
            channel: 'ptk_messages_channel',
            command: 'init_recording'
        }, '*')
    }



    function startRecording(url) {
        window.postMessage({
            channel: 'ptk_messages_channel',
            command: 'start_recording',
            params: {
                start_url: document.getElementById('startUrl').value,
                clean_cookie: false
            }
        }, '*')
    }

    function stopRecording() {
        window.postMessage({
            channel: 'ptk_messages_channel',
            command: 'stop_recording'
        }, '*')
    }


    function resetRecording() {
        window.postMessage({
            channel: 'ptk_messages_channel',
            command: 'reset_recording'
        }, '*')
    }


    function exportRecording() {
        document.getElementById('export').value = "";
        window.postMessage({
            channel: 'ptk_messages_channel',
            command: 'export_recording',
            params: {
                element: 'export', // element id
                settings: {
                    format: "xml", // [xml, har]
                    min_duration: 3000,
                    element_path: "id", //[id, fullpath]
                    event_type: "javascript", //[javascript, driverclick, onclick ]
                }
            }
        }, '*')
    }


    function checkMacro() {
        var parser = new DOMParser();
        var text = document.getElementById('export').value;
        var xmlDoc = parser.parseFromString(text, "text/xml");

        if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
            //checkErrorXML(xmlDoc.getElementsByTagName("parsererror")[0]);
            alert(xt)
        }
        else {
            alert("No errors found");
        }
    }
</script>
<!-- Main -->

<div class="inner">
    <div class="content">
        <h3>Selenium tests integration</h3>

        <iframe width="560" height="315" src="https://www.youtube.com/embed/yhi-Y_LW5P0" frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen></iframe>
         <br/>   
         <p></p>
        <h4>1. <b>Run Chrome with custom profile</b></h4>
        <p>
            Windows OS <br />
            <code>"C:\Program Files (x86)\Google\Chrome\Application\chrome.exe" --user-data-dir="C:\selenium\profile"</code>
        </p>
        <p>
            Mac OS <br />
            <code>/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome chrome --user-data-dir=/Users/ptk/selenium/profile</code>
        </p>
        <hr>

        <h4>2. <b>Install PTK chrome extension</b></h4>
        <p>
            See the installation step - <a href="howto.html#install">this link</a> or just copy and paste this <a
                href="https://chrome.google.com/webstore/detail/penetration-testing-kit/ojkchikaholjmcnefhjlbohackpeeknd">link</a>
            and install the PTK
        </p>
        <hr>
        <h4>3. <b>Enable R-Attacker external integration</b></h4>
        <p>
            Open PTK settings and enable R-Attacker integration. See <a href="howto.html#settings">this link</a>
        </p>
        <hr>

        <h4>4. <b>Modify Selenium tests</b></h4>
        <b>Initialisation</b>
        <p></p>
        <pre><code>
            [SetUp]
            public void SetupTest()
            {
                ChromeOptions options = new ChromeOptions();
                options.AddArguments("user-data-dir=/Users/ptk/selenium/profile");
                driver = new ChromeDriver(options);
            }
        </code></pre>

        <br>
        <b>Run R-Attacker scan</b>
        <p>To start the PTK scan from Selenium tests use javascript executor</p>
        <pre><code>
            driver.Navigate().GoToUrl("http://demo.testfire.net/index.jsp");
            Thread.Sleep(2000);

            IJavaScriptExecutor js = (IJavaScriptExecutor)driver;
            js.ExecuteScript("window.postMessage({'ptk_rattacker':'start'})");
            Thread.Sleep(1000);
        </code></pre>

        <b>Stop R-Attacker scan</b>
        <p>Stop the scan once all tests have finished</p>
        <pre><code>
            js.ExecuteScript("window.postMessage({'ptk_rattacker':'stop'});");
            Thread.Sleep(100);
        </code></pre>

        <hr />

        <b>Getting result</b>
        <p>Get findings as JSON string</p>
        <pre><code>
            string result = (string) js.ExecuteScript("return window.ptk_scan_result;");
        </code></pre>

        <hr />
        <h4>Supported commands:</h4>
        <ul>
            <li>{'ptk_rattacker':'start'}</li>
            <li>{'ptk_rattacker':'stop'}</li>
        </ul>

        <hr />

    </div>
</div>